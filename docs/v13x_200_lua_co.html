<html><head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap">
  <script src="https://kit.fontawesome.com/1e36e2dfe7.js" crossorigin="anonymous"></script>
  <script src="jquery.min.js"></script>
  <script src="bootstrap.min.js"></script>
  <script src="highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script src="fuse.min.js"></script>
  <script src="dox2web.js"></script>
  <title>Visionary Render Programming Guide: Lua Event Coroutines</title>
</head>
<body><a class="main-logo" href="https://www.virtalis.com" target="_blank" rel="noopener noreferrer"></a>
<nav class="navbar navbar-inverse navbar-fixed-top navbar-lower" role="navigation">
  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-nav-contents" aria-expanded="false">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <div class="collapse navbar-collapse" id="bs-nav-contents"><ul class="nav navbar-nav" id="main-menu">
    <li><a href="index.html">Overview</a></li>
    <li><a href="pages.html">Contents</a></li>
    <li><a href="modules.html">API</a></li>
  </ul>
</nav>
<div class="shove"><div class="container-fluid"><div class="col-sm-10 col-sm-push-2 main"><nav aria-label = "breadcrumb"><ol class="breadcrumb forward-slash"><li class = "breadcrumb-item "><a href = "index.html">Overview</a></li><li class = "breadcrumb-item"><a href="changes.html">Changelog</a></li><li class = "breadcrumb-item"><a href="v13x_to_v2.html">New in 2.0.0</a></li><li class = "breadcrumb-item active">Lua Event Coroutines</li></ol></nav><div class="page-toc"><ol><li><strong>Contents</strong></li><li><a href="#">Lua Event Coroutines</a></li><ol><li><a href="#PMxXOLBTNtYU">Introduction</a></li><ol><li><a href="#yvS6cXzpTtX4">Gotchas</a></li></ol><li><a href="#vf4xRgVJLesc">Global Variables</a></li><li><a href="#GnsUybBtYxKi">Recompiling coroutines</a></li><li><a href="#2ztqfRPm59Ar">Managing sleeping coroutines</a></li></ol></div><h1>Lua Event Coroutines</h1><p>Event handler scripts and the main Scripts console window now execute as coroutines.</p><p><h2 class="anchor" id="PMxXOLBTNtYU">Introduction</h2></p><p>A coroutine is a piece of code that may pause its execution and resume at some point in the future. In Visionary Render they can be used to control the flow of an event script, in most cases so that it can perform time-based operations sequentially.</p><p>Consider this basic example using <a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield</a>:</p><p><div id="frag_tp4cjnLEHd6V"><ul class="nav nav-pills"><li class="active"><a href="#Luatp4cjnLEHd6V">Lua</a></li></ul><div class="tab-content"><div id="Luatp4cjnLEHd6V" class="tab-pane active"><pre><code class="lua">for i = 1, 10 do
  print(i)
  vrYield(0.5)
end
</code></pre></div>
</div></div>
This prints the numbers 1 through 10 to the application log (and Lua output window) over 5 seconds, printing one number and sleeping for half a second.</p><p>To do this without yielding, you would have to use a Timestep event and a piece of metadata or a global variable to track the value of <code>i</code>.</p><p><h3 class="anchor" id="yvS6cXzpTtX4">Gotchas</h3></p><p>There are some issues yielding inside for loops, most obviously when using iterators such as <code>pairs</code>, but also in nested loops.</p><p>The following code may randomly fail with a <code>nil access</code> error on the next iteration:</p><p><div id="frag_T8GwpTZx9lpY"><ul class="nav nav-pills"><li class="active"><a href="#LuaT8GwpTZx9lpY">Lua</a></li></ul><div class="tab-content"><div id="LuaT8GwpTZx9lpY" class="tab-pane active"><pre><code class="lua">local t = {1, 2, 3}
for i, v in ipairs(t) do
  print(i, v)
  vrYield(0.5) -- don&apos;t do this here...
end
</code></pre></div>
</div></div>
Equally, this code will fail after a while because it thinks <code>u</code> is nil:</p><p><div id="frag_sm1xiT96e4Nn"><ul class="nav nav-pills"><li class="active"><a href="#Luasm1xiT96e4Nn">Lua</a></li></ul><div class="tab-content"><div id="Luasm1xiT96e4Nn" class="tab-pane active"><pre><code class="lua">local t = 100
local u = 100
while t &gt; 1 do
  while u &gt; 1 do
    vrYield(0)
    u = u - 1
  end
  t = t - 1
end
</code></pre></div>
</div></div>
The most stable way is to structure the code so that the yielding logic is in a function call, and that function does not contain loops. For example, this should be fine:</p><p><div id="frag_msYNdier0HZ2"><ul class="nav nav-pills"><li class="active"><a href="#LuamsYNdier0HZ2">Lua</a></li></ul><div class="tab-content"><div id="LuamsYNdier0HZ2" class="tab-pane active"><pre><code class="lua">local function doU(u)
  --do stuff with u
  vrYield(0)
end

local t = 100
local u = 100
while t &gt; 1 do
  while u &gt; 1 do
    doU(u)
    u = u - 1
  end
  t = t - 1
end
</code></pre></div>
</div></div><h2 class="anchor" id="vf4xRgVJLesc">Global Variables</h2></p><p>When writing a script that makes use of <a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield</a>, it is important to understand that global variables are shared between the main Lua state and any coroutines. This means that when your script yields, the values of any global variables are not guaranteed to be the same when the script resumes.</p><p>For example:</p><p><div id="frag_GuezCQ0xnHhZ"><ul class="nav nav-pills"><li class="active"><a href="#LuaGuezCQ0xnHhZ">Lua</a></li></ul><div class="tab-content"><div id="LuaGuezCQ0xnHhZ" class="tab-pane active"><pre><code class="lua">-- AssemblyA.EventCreate
print(__Self) -- prints AssemblyA
vrYield(0.1)
print(__Self) -- prints an undefined node (probably not AssemblyA)
</code></pre></div>
</div></div>
If a script needs access to the global values it expects when the script it first executed, it should localise them somewhere in the script before the first call to <a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield</a>.</p><p><div id="frag_UbwQZPQ02YiF"><ul class="nav nav-pills"><li class="active"><a href="#LuaUbwQZPQ02YiF">Lua</a></li></ul><div class="tab-content"><div id="LuaUbwQZPQ02YiF" class="tab-pane active"><pre><code class="lua">-- AssemblyA.EventCreate
local me = __Self
print(me) -- prints AssemblyA
vrYield(0.1)
print(me) -- prints AssemblyA
</code></pre></div>
</div></div><h2 class="anchor" id="GnsUybBtYxKi">Recompiling coroutines</h2></p><p>When editing scripts involving <a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield</a>, compilation will automatically abort any previously running (and still sleeping) instances of the code. This is to avoid long running scripts becoming stuck, and waking up to perform out of date instructions which will most likely cause issues in the scripted simulations in the scene.</p><p>The exception to this is when executing code in the script console - no cleanup is done on the previously executing coroutine. This is intentional, because sometimes it is useful to write some test code that involves a long running script, and then also execute other code while that is running.</p><p><h2 class="anchor" id="2ztqfRPm59Ar">Managing sleeping coroutines</h2></p><p>When a script calls <a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield</a>, it goes to sleep for the specified (approximate) time. When this happens it is put into a list with all the other sleeping scripts, which is accessible from Lua itself using <a href="group__api__lua.html#1ga768bd66e691b4bfd80c6b3a0dc9936ba" title="Lists the scripts currently suspended, awaiting resume">vrListSleepingScripts</a>. This returns an array of sleeping coroutine names.</p><p>The name of a script can be set using <a href="group__api__lua.html#1gaa1577b33b1a2dc58d498d0acb2c777a9" title="Sets an identifier for the Lua execution">vrSetScriptIdentifier</a>, otherwise the name will just be a string representation of the coroutine memory address. This is not used for anything other than identification purposes and as the parameter to <a href="group__api__lua.html#1ga4473693b9d5020e2960564f1e315b3a4" title="Aborts a suspended script">vrAbortScript</a>, which can be used to abort a sleeping coroutine.</p><p>This can also be done using the Lua State tab in the Diagnostics window. The left panel displays the state of global variables, the right panel displays any sleeping scripts and provides an option to abort them.</p><p><img src="diagnostics_window.png"></img></p><hr/><div class="row footer-nav footer-links"><div class="col-sm-4"><p><span class="fas fa-arrow-circle-left" aria-hidden="true"></span>&nbsp;<a href="v13x_200_pivots.html">Pivot API Changes</a></p></div><div class="col-sm-4 col-sm-offset-4"><p class="pull-right"><a href="v13x_200_lua_observers.html">Lua Observers</a>&nbsp;<span class="fas fa-arrow-circle-right" aria-hidden="true"></span></p></div></div></div><div class="col-sm-2 col-sm-pull-10 "><div class="main-search"><form id="docs-search" autocomplete="off" class="form-horizontal" accept-charset="utf-8"><div class="input-group text-border"><input name="srch-term" id="srch-term" class="form-control" type="text" placeholder="Search"></div></form></div><div id="searchResults"><div class="list-group"><p class="list-group-item">No Results.</p></div></div><div class="list-group list-group-root"><span class="list-group-item"><a href="#side_getting_started" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="getting_started.html">Getting Started</a></span><div class="list-group collapse" id="side_getting_started"><span class="list-group-item"><a href="applua_intro.html">Using the Script Editor</a></span><span class="list-group-item"><a href="eventlua_intro.html">Using the Script Event System</a></span><span class="list-group-item"><a href="luaplugin_intro.html">Creating a Lua Plugin</a></span><span class="list-group-item"><a href="plugin_intro.html">Creating a Native Plugin</a></span><span class="list-group-item"><a href="plugin_wrangle_api.html">Accessing the API</a></span></div><span class="list-group-item"><a href="#side_architecture" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="architecture.html">Architecture</a></span><div class="list-group collapse" id="side_architecture"><span class="list-group-item"><a href="api_diagram.html">API Diagram</a></span><span class="list-group-item"><a href="metanodes.html">Metanodes</a></span><span class="list-group-item"><a href="properties.html">Properties</a></span><span class="list-group-item"><a href="nodes.html">Nodes</a></span><span class="list-group-item"><a href="observers.html">Observers</a></span><span class="list-group-item"><a href="scenegraph.html">Scene Graph</a></span><span class="list-group-item"><a href="plugin_directories.html">Plugin Search Paths</a></span></div><span class="list-group-item"><a href="best_practices.html">Best Practices</a></span><span class="list-group-item"><a href="#side_howto" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto.html">How To</a></span><div class="list-group collapse" id="side_howto"><span class="list-group-item"><a href="#side_howto_lua" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto_lua.html">Scripts</a></span><div class="list-group collapse" id="side_howto_lua"><span class="list-group-item"><a href="lua_assembly_howto.html">Work with Assembly Nodes</a></span><span class="list-group-item"><a href="lua_visual_howto.html">Work with Visual Nodes</a></span><span class="list-group-item"><a href="lua_light_howto.html">Work with Light Nodes</a></span><span class="list-group-item"><a href="lua_material_howto.html">Work with Material Nodes</a></span><span class="list-group-item"><a href="lua_lodgeo_howto.html">Work with Level of Detail and GeoGroup Nodes</a></span><span class="list-group-item"><a href="lua_sequence_howto.html">Work with Sequence Nodes</a></span><span class="list-group-item"><a href="lua_audio_howto.html">Work with Audio Nodes</a></span><span class="list-group-item"><a href="lua_video_howto.html">Work with Movie Nodes</a></span><span class="list-group-item"><a href="lua_metadata_howto.html">Work with Metadata and Attribute Nodes</a></span><span class="list-group-item"><a href="lua_settings_howto.html">Work with Settings Nodes</a></span><span class="list-group-item"><a href="lua_observers_howto.html">Work with Observers</a></span></div><span class="list-group-item"><a href="#side_howto_plugins" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto_plugins.html">Plugins</a></span><div class="list-group collapse" id="side_howto_plugins"><span class="list-group-item"><a href="importer_howto.html">Provide a Data Importer</a></span><span class="list-group-item"><a href="exporter_howto.html">Provide a Data Exporter</a></span><span class="list-group-item"><a href="context_menu_howto.html">Add a Context Menu</a></span><span class="list-group-item"><a href="ffi_howto.html">Use the Foreign Function Interface (FFI)</a></span><span class="list-group-item"><a href="luafunc_howto.html">Provide a Lua Function</a></span><span class="list-group-item"><a href="define_metanode_howto.html">Define a Custom MetaNode</a></span><span class="list-group-item"><a href="update_howto.html">Implement an Update Function</a></span><span class="list-group-item"><a href="observer_howto.html">Implement an Observer</a></span><span class="list-group-item"><a href="logging_howto.html">Write to the Application Log</a></span><span class="list-group-item"><a href="dialog_howto.html">Present a Modal Dialog</a></span><span class="list-group-item"><a href="progress_howto.html">Update the Loading Screen</a></span></div></div><span class="list-group-item"><a href="#side_advanced" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="advanced.html">Advanced Topics</a></span><div class="list-group collapse" id="side_advanced"><span class="list-group-item"><a href="advanced_appcommands.html">Application Commands</a></span><span class="list-group-item"><a href="advanced_semantics.html">Semantics</a></span><span class="list-group-item"><a href="advanced_metanode_versioning.html">Metanode Versioning</a></span><span class="list-group-item"><a href="dynamic_loading.html">Enabling/Disabling Plugins at Runtime</a></span><span class="list-group-item"><a href="lua_coroutines.html">Coroutines in Lua Plugins</a></span><span class="list-group-item"><a href="lua_odbc.html">Using LuaSQL for ODBC Connections</a></span><span class="list-group-item"><a href="lua_com.html">Reference External Data Using the COM</a></span><span class="list-group-item"><a href="terminating_long_scripts.html">Terminating Long Scripts</a></span><span class="list-group-item"><a href="plugin_depends.html">Plugin Dependencies</a></span><span class="list-group-item"><a href="surface_shader_intro.html">Writing Surface Shaders</a></span><span class="list-group-item"><a href="view_shader_intro.html">Writing View Shaders</a></span></div><span class="list-group-item show-path"><a href="#side_changes" data-toggle="collapse"><i class="fas fa-minus-square list-toggle"></i></a><a href="changes.html">Changelog</a></span><div class="list-group collapse in" id="side_changes"><span class="list-group-item"><a href="v2023_2_to_v2024_1.html">New in 2024.1</a></span><span class="list-group-item"><a href="v2023_1_to_v2023_2.html">New in 2023.2</a></span><span class="list-group-item"><a href="v2021_2_to_v2021_3.html">New in 2021.3</a></span><span class="list-group-item"><a href="v2021_1_to_v2021_2.html">New in 2021.2</a></span><span class="list-group-item"><a href="v2020_2_to_v2021_1.html">New in 2021.1</a></span><span class="list-group-item"><a href="v2020_1_to_v2020_2.html">New in 2020.2</a></span><span class="list-group-item"><a href="v2019_3_to_v2020_1.html">New in 2020.1</a></span><span class="list-group-item"><a href="v2019_2_to_v2019_3.html">New in 2019.3</a></span><span class="list-group-item"><a href="v22_to_v2019_2.html">New in 2019.2</a></span><span class="list-group-item"><a href="v21_to_v22.html">New in 2.2.0</a></span><span class="list-group-item"><a href="v20_to_v21.html">New in 2.1.0</a></span><span class="list-group-item show-path"><a href="#side_v13x_to_v2" data-toggle="collapse"><i class="fas fa-minus-square list-toggle"></i></a><a href="v13x_to_v2.html">New in 2.0.0</a></span><div class="list-group collapse in" id="side_v13x_to_v2"><span class="list-group-item"><a href="v13x_200_pivots.html">Pivot API Changes</a></span><span class="list-group-item show-path"><a href="v13x_200_lua_co.html">Lua Event Coroutines</a></span><span class="list-group-item"><a href="v13x_200_lua_observers.html">Lua Observers</a></span></div></div><span class="list-group-item"><a href="namespacevrtree.html">vrtree</a></span><span class="list-group-item"><a href="namespacevrtree__cpp.html">vrtree_cpp</a></span><span class="list-group-item"><a href="namespacevt_core.html">vtCore</a></span><span class="list-group-item"><a href="group__api__core.html">Core</a></span><span class="list-group-item"><a href="group__api__ffi.html">Foreign Function Interface</a></span><span class="list-group-item"><a href="#side_group__api__metanodes" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__metanodes.html">Metanodes</a></span><div class="list-group collapse" id="side_group__api__metanodes"><span class="list-group-item"><a href="group__api__metanodes__general.html">General</a></span><span class="list-group-item"><a href="group__api__metanodes__properties.html">Properties</a></span><span class="list-group-item"><a href="group__api__metanodes__semantics.html">Semantics and Hints</a></span><span class="list-group-item"><a href="group__api__metadefs.html">Metanode Structure Definitions</a></span></div><span class="list-group-item"><a href="group__api__migrations.html">Migrations</a></span><span class="list-group-item"><a href="group__api__observer.html">Observers</a></span><span class="list-group-item"><a href="group__api__properties.html">Properties</a></span><span class="list-group-item"><a href="group__api__settings.html">Settings</a></span><span class="list-group-item"><a href="group__api__tree.html">Tree</a></span><span class="list-group-item"><a href="group__api__utils.html">Utilities</a></span><span class="list-group-item"><a href="#side_group__api__defs" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__defs.html">API Definitions</a></span><div class="list-group collapse" id="side_group__api__defs"><span class="list-group-item"><a href="group__api__types.html">Types</a></span><span class="list-group-item"><a href="group__api__proto.html">Function Prototypes</a></span><span class="list-group-item"><a href="group__api__flags.html">Flags</a></span><span class="list-group-item"><a href="group__api__io__flags.html">Save/Load Tree I/O Flags</a></span><span class="list-group-item"><a href="group__api__builder__flags.html">Build Filter flags</a></span><span class="list-group-item"><a href="group__api__loggingmask.html">Logging masks</a></span><span class="list-group-item"><a href="group__api__errors.html">Error codes</a></span></div><span class="list-group-item"><a href="group__api__exchange.html">VR Exchange</a></span><span class="list-group-item"><a href="#side_group__api__plugins" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__plugins.html">Plugins</a></span><div class="list-group collapse" id="side_group__api__plugins"><span class="list-group-item"><a href="group__api__plugin__interface.html">Plugin Interface</a></span><span class="list-group-item"><a href="group__api__plugin__utils.html">Plugin Utilities</a></span></div><span class="list-group-item"><a href="group__api__lua.html">Lua API</a></span></div></div>
</div></div></body></html>