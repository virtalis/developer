<html><head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap">
  <script src="https://kit.fontawesome.com/1e36e2dfe7.js" crossorigin="anonymous"></script>
  <script src="jquery.min.js"></script>
  <script src="bootstrap.min.js"></script>
  <script src="highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script src="fuse.min.js"></script>
  <script src="dox2web.js"></script>
  <title>Visionary Render Programming Guide: Reference External Data Using the COM</title>
</head>
<body><a class="main-logo" href="https://www.virtalis.com" target="_blank" rel="noopener noreferrer"></a>
<nav class="navbar navbar-inverse navbar-fixed-top navbar-lower" role="navigation">
  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-nav-contents" aria-expanded="false">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <div class="collapse navbar-collapse" id="bs-nav-contents"><ul class="nav navbar-nav" id="main-menu">
    <li><a href="index.html">Overview</a></li>
    <li><a href="pages.html">Contents</a></li>
    <li><a href="modules.html">API</a></li>
  </ul>
</nav>
<div class="shove"><div class="container-fluid"><div class="col-sm-10 col-sm-push-2 main"><nav aria-label = "breadcrumb"><ol class="breadcrumb forward-slash"><li class = "breadcrumb-item "><a href = "index.html">Overview</a></li><li class = "breadcrumb-item"><a href="advanced.html">Advanced Topics</a></li><li class = "breadcrumb-item active">Reference External Data Using the COM</li></ol></nav><div class="page-toc"><ol><li><strong>Contents</strong></li><li><a href="#">Reference External Data Using the COM</a></li><ol><li><a href="#8tZN1kCh4tzz">Web Services</a></li><li><a href="#6D86nWa0Xc7d">Excel Spreadsheets</a></li></ol></div><h1>Reference External Data Using the COM</h1><p>Using Lua and the Microsoft Component Object Model (COM) to interact with external data sources</p><p>Visionary Render supports <a href="http://lua-users.org/wiki/LuaCom">LuaCOM</a>, a library which allows Lua scripts to interact with the <a href="https://docs.microsoft.com/en-us/windows/desktop/com/the-component-object-model">COM</a>. In all scripts, the global interface named <code>luacom</code> is available by default, to be accessed as described by the API documentation linked above. Below are a couple of examples of what this can do.</p><p><h2 class="anchor" id="8tZN1kCh4tzz">Web Services</h2></p><p>To access web data, the <code>MSXML2.XMLHTTP</code> object can be used. In the example below, we start by calling <code>luacom.CreateObject</code> to make an instance of this. Note that if the application will be making multiple HTTP requests, it is more efficient to reuse the same XMLHTTP object than recreating it each time. In this case, the object is local, and will be destroyed when the script terminates.</p><p>Next, we call <code>open</code> on the <code>web</code> object, passing it the <code>GET</code> method and desired URL. The third argument, <code>true</code>, is for the <code>async</code> parameter on <code>web:open()</code>. This allows the script to continue running while the server is contacted, as otherwise, the entire application would lock up.</p><p>After we have sent the request we take advantage of the Lua coroutines supported by Visionary Render. To block the script from completing until the request has completed, the script calls <code><a href="group__api__lua.html#1gaf006dd0b9b28944df930a54119c6e7c2" title="Yields the Lua execution back to the application for the (approximate) specified time">vrYield()</a></code> in a loop. This allows Visionary Render to continue updating, checking on the status of the request every frame. When it has finished, we print the result. Note that it is important to use a timeout for web requests, as we can never know how long the server may take to respond, and should handle the case where it never does. This is achieved by checking the <code>__Time</code> register. The <code>readyState</code> variable will be 1 (<code>LOADING</code>) when we initiate the request, and will step through a number of other states until the operation completes on 4 (<code>COMPLETED</code>).</p><p><div id="frag_4on2Yep1zD4F"><ul class="nav nav-pills"><li class="active"><a href="#Lua4on2Yep1zD4F">Lua</a></li></ul><div class="tab-content"><div id="Lua4on2Yep1zD4F" class="tab-pane active"><pre><code class="lua">function httpRequest(url)
  -- Create the COM object.
  local web = luacom.CreateObject(&quot;MSXML2.XMLHTTP&quot;)

  -- Make an asynchronous request.
  web:open(&quot;GET&quot;, url, true)
  web:send()

  -- Yield until done, or time out after 10 seconds.
  local timeout = 10
  local startTime = __Time
  while web.readyState &lt; 4 and __Time - startTime &lt; timeout do
    vrYield()
  end

  -- Print the result.
  print(web.responseText)
end
</code></pre></div>
</div></div><h2 class="anchor" id="6D86nWa0Xc7d">Excel Spreadsheets</h2></p><p><strong>Important:</strong> This requires a valid Microsoft Excel license.</p><p>Moreso than contacting web servers, the COM is known for its ability to interface with Microsoft applications. In the next example we will read data from an Excel spreadsheet.</p><p>In this case we create an <code>Excel.Application</code> object. As before, this can be a slow operation, so it is beneficial to reuse the object.</p><p>Next, we open the desired file with <code>excel.Workbooks:Open()</code>. This demonstrates LuaCOM's partial support for named parameters; the <code>Open()</code> function takes a number of named parameters, which in a language like Visual Basic can be specified in any order. Unfortunately, in Lua, we must pass them in order. This means that we specify the <code>FileName</code>, then leave <code>UpdatedLinks</code> as nil, so we can set <code>ReadOnly</code> to true - for this specific case the arguments can be found <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.workbooks.open">here</a>.</p><p>After this we examine the first sheet in the workbook. We can read the entire used section of the sheet into a Lua table by taking advantage of the <code>UsedRange</code> property on the sheet. This is much faster than calling the COM for every cell. <code>Value()</code> returns a Lua primitive for a single cell, or a table for a range.</p><p>Finally, we <code>Close()</code> the workbook, passing <code>false</code> to say we don't want to save any changes. Unlike the COM objects themselves, which are destroyed when they go out of scope, we must do this manually. The function caller now has access to the data from the spreadsheet.</p><p>As a final note, it is not advised to use this method for very large spreadsheets, due to both Lua's memory constraints and performance of the COM. If you have a very large data set, a more suitable approach may be to export from Excel in another format such as csv, and load that incrementally.</p><p><div id="frag_vXiB9trlvhFb"><ul class="nav nav-pills"><li class="active"><a href="#LuavXiB9trlvhFb">Lua</a></li></ul><div class="tab-content"><div id="LuavXiB9trlvhFb" class="tab-pane active"><pre><code class="lua">function loadExcel(filename)
  -- Create the COM object.
  local excel = luacom.CreateObject(&quot;Excel.Application&quot;)

  -- Load the file as read-only.
  local workbook = excel.Workbooks:Open(filename, nil, true)
  local sheet = workbook.Sheets(1)

  -- Read the whole sheet in one go.
  local sheetData = sheet.UsedRange:Value()

  -- Close the file.
  workbook:Close(false)

  return sheetData
end
</code></pre></div>
</div></div></p><hr/><div class="row footer-nav footer-links"><div class="col-sm-4"><p><span class="fas fa-arrow-circle-left" aria-hidden="true"></span>&nbsp;<a href="lua_odbc.html">Using LuaSQL for ODBC Connections</a></p></div><div class="col-sm-4 col-sm-offset-4"><p class="pull-right"><a href="terminating_long_scripts.html">Terminating Long Scripts</a>&nbsp;<span class="fas fa-arrow-circle-right" aria-hidden="true"></span></p></div></div></div><div class="col-sm-2 col-sm-pull-10 "><div class="main-search"><form id="docs-search" autocomplete="off" class="form-horizontal" accept-charset="utf-8"><div class="input-group text-border"><input name="srch-term" id="srch-term" class="form-control" type="text" placeholder="Search"></div></form></div><div id="searchResults"><div class="list-group"><p class="list-group-item">No Results.</p></div></div><div class="list-group list-group-root"><span class="list-group-item"><a href="#side_getting_started" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="getting_started.html">Getting Started</a></span><div class="list-group collapse" id="side_getting_started"><span class="list-group-item"><a href="applua_intro.html">Using the Script Editor</a></span><span class="list-group-item"><a href="eventlua_intro.html">Using the Script Event System</a></span><span class="list-group-item"><a href="luaplugin_intro.html">Creating a Lua Plugin</a></span><span class="list-group-item"><a href="plugin_intro.html">Creating a Native Plugin</a></span><span class="list-group-item"><a href="plugin_wrangle_api.html">Accessing the API</a></span></div><span class="list-group-item"><a href="#side_architecture" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="architecture.html">Architecture</a></span><div class="list-group collapse" id="side_architecture"><span class="list-group-item"><a href="api_diagram.html">API Diagram</a></span><span class="list-group-item"><a href="metanodes.html">Metanodes</a></span><span class="list-group-item"><a href="properties.html">Properties</a></span><span class="list-group-item"><a href="nodes.html">Nodes</a></span><span class="list-group-item"><a href="observers.html">Observers</a></span><span class="list-group-item"><a href="scenegraph.html">Scene Graph</a></span><span class="list-group-item"><a href="plugin_directories.html">Plugin Search Paths</a></span></div><span class="list-group-item"><a href="best_practices.html">Best Practices</a></span><span class="list-group-item"><a href="#side_howto" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto.html">How To</a></span><div class="list-group collapse" id="side_howto"><span class="list-group-item"><a href="#side_howto_lua" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto_lua.html">Scripts</a></span><div class="list-group collapse" id="side_howto_lua"><span class="list-group-item"><a href="lua_assembly_howto.html">Work with Assembly Nodes</a></span><span class="list-group-item"><a href="lua_visual_howto.html">Work with Visual Nodes</a></span><span class="list-group-item"><a href="lua_light_howto.html">Work with Light Nodes</a></span><span class="list-group-item"><a href="lua_material_howto.html">Work with Material Nodes</a></span><span class="list-group-item"><a href="lua_lodgeo_howto.html">Work with Level of Detail and GeoGroup Nodes</a></span><span class="list-group-item"><a href="lua_sequence_howto.html">Work with Sequence Nodes</a></span><span class="list-group-item"><a href="lua_audio_howto.html">Work with Audio Nodes</a></span><span class="list-group-item"><a href="lua_video_howto.html">Work with Movie Nodes</a></span><span class="list-group-item"><a href="lua_metadata_howto.html">Work with Metadata and Attribute Nodes</a></span><span class="list-group-item"><a href="lua_settings_howto.html">Work with Settings Nodes</a></span><span class="list-group-item"><a href="lua_observers_howto.html">Work with Observers</a></span></div><span class="list-group-item"><a href="#side_howto_plugins" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="howto_plugins.html">Plugins</a></span><div class="list-group collapse" id="side_howto_plugins"><span class="list-group-item"><a href="importer_howto.html">Provide a Data Importer</a></span><span class="list-group-item"><a href="exporter_howto.html">Provide a Data Exporter</a></span><span class="list-group-item"><a href="context_menu_howto.html">Add a Context Menu</a></span><span class="list-group-item"><a href="ffi_howto.html">Use the Foreign Function Interface (FFI)</a></span><span class="list-group-item"><a href="luafunc_howto.html">Provide a Lua Function</a></span><span class="list-group-item"><a href="define_metanode_howto.html">Define a Custom MetaNode</a></span><span class="list-group-item"><a href="update_howto.html">Implement an Update Function</a></span><span class="list-group-item"><a href="observer_howto.html">Implement an Observer</a></span><span class="list-group-item"><a href="logging_howto.html">Write to the Application Log</a></span><span class="list-group-item"><a href="dialog_howto.html">Present a Modal Dialog</a></span><span class="list-group-item"><a href="progress_howto.html">Update the Loading Screen</a></span></div></div><span class="list-group-item show-path"><a href="#side_advanced" data-toggle="collapse"><i class="fas fa-minus-square list-toggle"></i></a><a href="advanced.html">Advanced Topics</a></span><div class="list-group collapse in" id="side_advanced"><span class="list-group-item"><a href="advanced_appcommands.html">Application Commands</a></span><span class="list-group-item"><a href="advanced_semantics.html">Semantics</a></span><span class="list-group-item"><a href="advanced_metanode_versioning.html">Metanode Versioning</a></span><span class="list-group-item"><a href="dynamic_loading.html">Enabling/Disabling Plugins at Runtime</a></span><span class="list-group-item"><a href="lua_coroutines.html">Coroutines in Lua Plugins</a></span><span class="list-group-item"><a href="lua_odbc.html">Using LuaSQL for ODBC Connections</a></span><span class="list-group-item show-path"><a href="lua_com.html">Reference External Data Using the COM</a></span><span class="list-group-item"><a href="terminating_long_scripts.html">Terminating Long Scripts</a></span><span class="list-group-item"><a href="plugin_depends.html">Plugin Dependencies</a></span><span class="list-group-item"><a href="surface_shader_intro.html">Writing Surface Shaders</a></span><span class="list-group-item"><a href="view_shader_intro.html">Writing View Shaders</a></span></div><span class="list-group-item"><a href="#side_changes" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="changes.html">Changelog</a></span><div class="list-group collapse" id="side_changes"><span class="list-group-item"><a href="v2023_2_to_v2024_1.html">New in 2024.1</a></span><span class="list-group-item"><a href="v2023_1_to_v2023_2.html">New in 2023.2</a></span><span class="list-group-item"><a href="v2021_2_to_v2021_3.html">New in 2021.3</a></span><span class="list-group-item"><a href="v2021_1_to_v2021_2.html">New in 2021.2</a></span><span class="list-group-item"><a href="v2020_2_to_v2021_1.html">New in 2021.1</a></span><span class="list-group-item"><a href="v2020_1_to_v2020_2.html">New in 2020.2</a></span><span class="list-group-item"><a href="v2019_3_to_v2020_1.html">New in 2020.1</a></span><span class="list-group-item"><a href="v2019_2_to_v2019_3.html">New in 2019.3</a></span><span class="list-group-item"><a href="v22_to_v2019_2.html">New in 2019.2</a></span><span class="list-group-item"><a href="v21_to_v22.html">New in 2.2.0</a></span><span class="list-group-item"><a href="v20_to_v21.html">New in 2.1.0</a></span><span class="list-group-item"><a href="#side_v13x_to_v2" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="v13x_to_v2.html">New in 2.0.0</a></span><div class="list-group collapse" id="side_v13x_to_v2"><span class="list-group-item"><a href="v13x_200_pivots.html">Pivot API Changes</a></span><span class="list-group-item"><a href="v13x_200_lua_co.html">Lua Event Coroutines</a></span><span class="list-group-item"><a href="v13x_200_lua_observers.html">Lua Observers</a></span></div></div><span class="list-group-item"><a href="namespacevrtree.html">vrtree</a></span><span class="list-group-item"><a href="namespacevrtree__cpp.html">vrtree_cpp</a></span><span class="list-group-item"><a href="namespacevt_core.html">vtCore</a></span><span class="list-group-item"><a href="group__api__core.html">Core</a></span><span class="list-group-item"><a href="group__api__ffi.html">Foreign Function Interface</a></span><span class="list-group-item"><a href="#side_group__api__metanodes" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__metanodes.html">Metanodes</a></span><div class="list-group collapse" id="side_group__api__metanodes"><span class="list-group-item"><a href="group__api__metanodes__general.html">General</a></span><span class="list-group-item"><a href="group__api__metanodes__properties.html">Properties</a></span><span class="list-group-item"><a href="group__api__metanodes__semantics.html">Semantics and Hints</a></span><span class="list-group-item"><a href="group__api__metadefs.html">Metanode Structure Definitions</a></span></div><span class="list-group-item"><a href="group__api__migrations.html">Migrations</a></span><span class="list-group-item"><a href="group__api__observer.html">Observers</a></span><span class="list-group-item"><a href="group__api__properties.html">Properties</a></span><span class="list-group-item"><a href="group__api__settings.html">Settings</a></span><span class="list-group-item"><a href="group__api__tree.html">Tree</a></span><span class="list-group-item"><a href="group__api__utils.html">Utilities</a></span><span class="list-group-item"><a href="#side_group__api__defs" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__defs.html">API Definitions</a></span><div class="list-group collapse" id="side_group__api__defs"><span class="list-group-item"><a href="group__api__types.html">Types</a></span><span class="list-group-item"><a href="group__api__proto.html">Function Prototypes</a></span><span class="list-group-item"><a href="group__api__flags.html">Flags</a></span><span class="list-group-item"><a href="group__api__io__flags.html">Save/Load Tree I/O Flags</a></span><span class="list-group-item"><a href="group__api__builder__flags.html">Build Filter flags</a></span><span class="list-group-item"><a href="group__api__loggingmask.html">Logging masks</a></span><span class="list-group-item"><a href="group__api__errors.html">Error codes</a></span></div><span class="list-group-item"><a href="group__api__exchange.html">VR Exchange</a></span><span class="list-group-item"><a href="#side_group__api__plugins" data-toggle="collapse"><i class="fas fa-plus-square list-toggle"></i></a><a href="group__api__plugins.html">Plugins</a></span><div class="list-group collapse" id="side_group__api__plugins"><span class="list-group-item"><a href="group__api__plugin__interface.html">Plugin Interface</a></span><span class="list-group-item"><a href="group__api__plugin__utils.html">Plugin Utilities</a></span></div><span class="list-group-item"><a href="group__api__lua.html">Lua API</a></span></div></div>
</div></div></body></html>